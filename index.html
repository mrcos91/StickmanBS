<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Stickman Plataforma</title>
  <style>
    body { margin: 0; overflow: hidden; background: #111; font-family: sans-serif; }
    canvas { display: block; margin: 0 auto; background: #111; }
    #gameOverScreen {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      display: none;
    }
    #restartBtn {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      background-color: #222;
      border: 2px solid white;
      color: white;
      cursor: pointer;
    }
    #restartBtn:hover {
      background-color: white;
      color: black;
    }
  </style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="400"></canvas>

<div id="gameOverScreen">
  <div id="finalScore">Has perdido</div>
  <button id="restartBtn">Volver a empezar</button>
</div>

<!-- Sonidos -->
<audio id="jumpSound" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg" preload="auto"></audio>
<audio id="fallSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
<audio id="bgMusic" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_9650a4183e.mp3?filename=8bit-loop-6566.mp3" preload="auto" loop></audio>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

const jumpSound = document.getElementById("jumpSound");
const fallSound = document.getElementById("fallSound");
const bgMusic = document.getElementById("bgMusic");
bgMusic.volume = 0.3;
bgMusic.play();

const gameOverScreen = document.getElementById("gameOverScreen");
const finalScoreText = document.getElementById("finalScore");
const restartBtn = document.getElementById("restartBtn");

let player, platforms, score, scrollOffset, highScore, keys, gameOver;

function initGame() {
  player = {
    x: 50, y: 300, width: 10, height: 30,
    dx: 0, dy: 0,
    jumping: 0,
  };

  gravity = 0.5;
  scrollOffset = 0;
  score = 0;
  keys = {};
  gameOver = false;
  highScore = localStorage.getItem("highScore") || 0;

  platforms = [
    { x: 0, y: 350, width: 800, height: 50 }
  ];

  // Añadir plataformas iniciales
  for (let i = 1; i <= 5; i++) {
    platforms.push(genPlatform(800 + i * 200));
  }
}

function genPlatform(x) {
  return {
    x: x,
    y: 280 + Math.random() * 100 - 50,
    width: 100,
    height: 20
  };
}

document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

restartBtn.addEventListener("click", () => {
  gameOverScreen.style.display = "none";
  initGame();
  loop();
});

function update() {
  if (gameOver) return;

  if (keys["ArrowRight"] || keys["d"]) player.dx = 3;
  else if (keys["ArrowLeft"] || keys["a"]) player.dx = -3;
  else player.dx = 0;

  if ((keys["ArrowUp"] || keys["w"] || keys[" "]) && player.jumping < 2 && !keys["_jumping"]) {
    player.dy = -10;
    player.jumping++;
    keys["_jumping"] = true;
    jumpSound.currentTime = 0;
    jumpSound.play();
  }
  if (!(keys["ArrowUp"] || keys["w"] || keys[" "])) {
    keys["_jumping"] = false;
  }

  player.dy += gravity;
  player.x += player.dx;
  player.y += player.dy;

  // Colisiones
  platforms.forEach(p => {
    if (
      player.x < p.x + p.width &&
      player.x + player.width > p.x &&
      player.y + player.height < p.y + 10 &&
      player.y + player.height + player.dy >= p.y
    ) {
      player.dy = 0;
      player.y = p.y - player.height;
      player.jumping = 0;
    }
  });

  // Scroll
  if (player.x > 400) {
    scrollOffset += player.dx;
    platforms.forEach(p => p.x -= player.dx);
    player.x = 400;
    score = Math.floor(scrollOffset / 10);
    if (score > highScore) {
      highScore = score;
      localStorage.setItem("highScore", highScore);
    }

    // Generar nuevas plataformas dinámicamente
    const lastPlatform = platforms[platforms.length - 1];
    if (lastPlatform.x < canvas.width) {
      platforms.push(genPlatform(lastPlatform.x + 200));
    }
  }

  // Caída
  if (player.y > canvas.height) {
    gameOver = true;
    fallSound.play();
    finalScoreText.innerHTML = `Game Over<br>Puntuación: ${score}<br>Récord: ${highScore}`;
    gameOverScreen.style.display = "flex";
  }
}

function drawStickman(x, y) {
  ctx.strokeStyle = "white";
  ctx.lineWidth = 2;
  ctx.beginPath(); ctx.arc(x + 5, y + 5, 5, 0, Math.PI * 2); ctx.stroke(); // Cabeza
  ctx.beginPath(); ctx.moveTo(x + 5, y + 10); ctx.lineTo(x + 5, y + 25); ctx.stroke(); // Cuerpo
  ctx.beginPath(); ctx.moveTo(x + 5, y + 15); ctx.lineTo(x - 5, y + 20); ctx.moveTo(x + 5, y + 15); ctx.lineTo(x + 15, y + 20); ctx.stroke(); // Brazos
  ctx.beginPath(); ctx.moveTo(x + 5, y + 25); ctx.lineTo(x - 2, y + 35); ctx.moveTo(x + 5, y + 25); ctx.lineTo(x + 12, y + 35); ctx.stroke(); // Piernas
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Plataformas
  ctx.fillStyle = "#444";
  platforms.forEach(p => ctx.fillRect(p.x, p.y, p.width, p.height));

  // Stickman
  drawStickman(player.x, player.y);

  // Puntuación
  ctx.fillStyle = "white";
  ctx.font = "18px monospace";
  ctx.fillText("Puntuación: " + score, 10, 25);
  ctx.fillText("Récord: " + highScore, 10, 50);
}

function loop() {
  update();
  draw();
  if (!gameOver) requestAnimationFrame(loop);
}

initGame();
loop();
</script>
</body>
</html>
